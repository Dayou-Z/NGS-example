---
title: "GSE230001"
author: "Dayou Zou"
date: "2024-07-09"
output: github_document
---


```{r, warning=FALSE}
library(affy)
library(limma)
library(GEOquery)
library(tinyarray)
library(clusterProfiler)
library(ggthemes)
library(org.Hs.eg.db)
library(dplyr)
library(ggplot2)
library(stringr)
library(enrichplot)
library(dplyr)
library(FactoMineR)
library(factoextra) 
library(hgu219.db)
library(pheatmap)
set.seed(1)
```

Expression matrices are provided on GEO, so start from expression matrices.
If no expression matrix on GEO, it can be generated by affy package. 
```{r}
# Expression matrices are provided on GEO, so start from expression matrices.
# If no expression matrix on GEO, it can be generated by affy package.
# dir_cels <- "../data/affy/GSE_230001_RAW"
# affydata <- ReadAffy(celfile.path = dir_cels)
# eset <- rma(affydata) or expresso() to specify bgcorrect, normalization,
# pm correct and stat methods.
# mtx <- exprs(eset)
# write.exprs(eset, file = "GSE230001_matrix.txt")
```

Data downloading and exploration
```{r}
eSet = getGEO("GSE230001", destdir = '../data/', getGPL = F)

#extract expression matrix
eSet = eSet[[1]] 
exp <- exprs(eSet)
dim(exp)
```

Draw box plot to check for abnormal samples
```{r}
range(exp)
boxplot(exp, las = 2)

exp <- exp[,1:6] # take subset of first 6 samples for training
```

Extract clinical information and gpl number for following annotation
```{r}
pd <- pData(eSet)[1:6,]

# Check if exp colnames match pd rownames
p <- identical(rownames(pd), colnames(exp)); p

gpl_number <- eSet@annotation; gpl_number
```

Organize group information
```{r}
k = str_detect(pd$title, "control"); k
group <- ifelse(k, "control", "estradiol")

group <- factor(group, levels = c("control","estradiol")); group
```

Get array annotation by tinyarray 
```{r}
# get 
find_anno(gpl_number)
```
```{r}
# get code from output above
library(hgu219.db);ids <- toTable(hgu219SYMBOL)
head(ids)
```

Check PCA plot and heatmap
```{r}
dat=as.data.frame(t(exp))
dat.pca <- PCA(dat, graph = FALSE)

p_pca<- fviz_pca_ind(dat.pca,
             geom.ind = "point", 
             col.ind = group,
             palette = c("#00AFBB", "#E7B800"),
             addEllipses = TRUE, 
             legend.title = "Groups"
)
p_pca
ggsave("../results/PCA.pdf", plot = p_pca)
```

heatmap for top1000 genes with high sd
```{r}
g = names(tail(sort(apply(exp,1,sd)),1000))
n = exp[g,]

annotation_col = data.frame(row.names = colnames(n),
                            Group = group)

p_heatmap_1000 <- pheatmap(n,
         show_colnames =F,
         show_rownames = F,
         annotation_col=annotation_col,
         scale = "row", 
         breaks = seq(-3,3,length.out = 100) 
         ) 
p_heatmap_1000

ggsave("../results/heatmap_1000.pdf", plot = p_heatmap_1000)
```

DE analysis (log2FC threshold is released due to few DEGs)
```{r}
# DE 
design = model.matrix(~group)
fit = lmFit(exp,design)
fit = eBayes(fit)
deg = topTable(fit,coef = 2,number = Inf)

# add probe_id info
deg = mutate(deg,probe_id = rownames(deg))
ids = distinct(ids,symbol,.keep_all = T)
deg = inner_join(deg,ids,by="probe_id")
nrow(deg)
```
```{r}
# add regulate label
logFC_t = 0.25
p_t = 0.05
k1 = (deg$P.Value < p_t)&(deg$logFC < -logFC_t)
k2 = (deg$P.Value < p_t)&(deg$logFC > logFC_t)
deg = mutate(deg,change = ifelse(k1,"down",ifelse(k2,"up","stable")))
table(deg$change)
```

Volcano plot
```{r}
p_vol <- ggplot(data = deg, aes(x = logFC, y = -log10(P.Value))) +
  geom_point(alpha=0.4, size=3.5, aes(color=change)) +
  scale_color_manual(values=c("blue", "grey","red"))+
  geom_vline(xintercept=c(-logFC_t,logFC_t),lty=4,col="black",linewidth=0.8) +
  geom_hline(yintercept = -log10(p_t),lty=4,col="black",linewidth=0.8) +
  theme_bw()
p_vol

ggsave("../results/volcano.pdf", plot = p_vol)
```

Heatmap for DEGs
```{r}
exp = exp[deg$probe_id,]
rownames(exp) = deg$symbol
diff_gene = deg$symbol[deg$change !="stable"]
n = exp[diff_gene,]
```
```{r}
annotation_col = data.frame(group = group)
rownames(annotation_col) = colnames(n) 
p_heatmap_deg <- pheatmap(n,show_colnames =F,
         show_rownames = F,
         scale = "row",
         #cluster_cols = F, 
         annotation_col=annotation_col,
         breaks = seq(-3,3,length.out = 100)
) 
p_heatmap_deg

ggsave("../results/heatmap_degs.pdf", plot = p_heatmap_deg)
```

Convert gene symbol to ENTREZID
```{r}
s2e = bitr(deg$symbol, 
           fromType = "SYMBOL",
           toType = "ENTREZID",
           OrgDb = org.Hs.eg.db)
           
deg = inner_join(deg,s2e,by=c("symbol"="SYMBOL"))

gene_diff = deg$ENTREZID[deg$change != "stable"] 
```

Enrichment analysis
```{r}
ekk <- enrichKEGG(gene = gene_diff,organism = 'hsa',pvalueCutoff = 1,qvalueCutoff = 1)

ekk <- setReadable(ekk,OrgDb = org.Hs.eg.db,keyType = "ENTREZID")
ego <- enrichGO(gene = gene_diff,OrgDb= org.Hs.eg.db,
                ont = "ALL",readable = TRUE)

class(ekk)
```

```{r}
# visualization
p_go <- barplot(ego, split = "ONTOLOGY") + 
  facet_grid(ONTOLOGY ~ ., space = "free_y",scales = "free_y")
p_go
ggsave("../results/GO.pdf", plot = p_go, height = 7, width = 7)

p_kkeg <- barplot(ekk); p_kkeg
ggsave("../results/KEGG.pdf", plot = p_kkeg, height = 5, width = 7)
```
















